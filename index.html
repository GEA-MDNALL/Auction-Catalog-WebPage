<!doctype html>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catalog</title>
<style type="text/css">
  :root { --gap: 20px; --card-radius: 14px; --max: 1200px; }
  body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #fafafa; }
  .catalog-toolbar { max-width: var(--max); margin: 0 auto 12px; display: flex; gap: 12px; }
  .catalog-toolbar input[type="search"] { flex: 1 1 280px; padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }

  .catalog-container { max-width: var(--max); margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .catalog-item { background: #fff; border: 1px solid #e9e9e9; border-radius: var(--card-radius); overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,.06); transition: transform .2s ease; display: flex; flex-direction: column; }
  .catalog-item:hover { transform: translateY(-3px); }
  .catalog-item[role="button"] { cursor: pointer; }

  .catalog-item .thumb { width: 100%; aspect-ratio: 4/3; background:#fff; position: relative; overflow: hidden; }
  .thumb .rail { display: flex; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; scrollbar-width: none; }
  .thumb .rail::-webkit-scrollbar { display: none; }
  .thumb .rail img { flex: 0 0 100%; width: 100%; height: 100%; object-fit: contain; background:#fff; scroll-snap-align: center; user-select: none; }

  .thumb .nav {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 8px;
    pointer-events: none;
    z-index: 5;
  }
  .thumb .nav button {
    pointer-events: auto;
    border: 0; background: transparent; color: #000; text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 8px rgba(0,0,0,.5);
    font-size: 20px; font-weight: 800; line-height: 1; width: auto; height: auto; border-radius: 0; padding: 8px 10px;
    cursor: pointer;
  }

  .catalog-item .pad { padding: 14px; display: flex; flex-direction: column; flex: 1; }
  .catalog-item h3 { margin: 6px 0 8px; font-size: 18px; }
  .meta { font-size: 14px; color: #555; margin-bottom: 10px; }
  .price { font-weight: 700; margin: 6px 0 12px; }
  .desc-snippet { font-size:14px; color:#555; margin-bottom:10px; white-space: pre-line; }
  .btn-row { margin-top: auto; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  .btn { display: inline-block; background:#000; color:#fff; text-decoration: none; padding:10px 18px; border-radius: 999px; font-weight: 700; }
  .btn:hover { background:#333; }
  .empty { max-width: var(--max); margin: 30px auto; color:#666; text-align:center; }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; padding: 28px; z-index: 1000; }
  .modal.open { display: flex; }
  .modal .dialog { background: #fff; border-radius: 14px; width: min(96vw, 1200px); overflow: hidden; }
  .modal .header { display:flex; justify-content: space-between; align-items:center; padding: 14px 16px; border-bottom: 1px solid #eee; }
  .modal .header h2 { font-size: 22px; margin: 0; }
  .modal .close { border: 0; background: #000; color:#fff; border-radius: 999px; padding:6px 12px; cursor: pointer; font-weight: 700; }
  .modal .body { display: grid; grid-template-columns: 1.3fr 1fr; gap: 16px; padding: 16px; }

  .m-media { position: relative; background: #fff; border-radius: 10px; overflow: hidden; min-height: clamp(360px, 55vh, 740px); }
  .m-rail { display: flex; height: 100%; aspect-ratio: 4/3; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; scrollbar-width: none; background:#fff; }
  .m-rail::-webkit-scrollbar { display: none; }
  .m-rail .slide { flex: 0 0 100%; height: 100%; position: relative; }
  .zoom-wrap { width: 100%; height: 100%; overflow: hidden; touch-action: none; cursor: grab; }
  .zoom-wrap:active { cursor: grabbing; }
  .zoom-img { width: 100%; height: 100%; object-fit: contain; transform-origin: 50% 50%; will-change: transform; user-drag: none; user-select: none; }

  .m-nav {
    position: absolute; inset: 0 0 calc(0 + env(safe-area-inset-bottom)) 0;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 8px;
    pointer-events: none;
    z-index: 5;
  }
  .m-nav button {
    pointer-events: auto;
    border: 0; background: transparent; color: #000; text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 8px rgba(0,0,0,.5);
    font-size: 22px; font-weight: 800; line-height: 1; width: auto; height: auto; border-radius: 0; padding: 10px 12px;
    cursor: pointer;
  }

  .m-info .price { margin: 6px 0 14px; font-size: 18px; }
  .m-info .btn-row { margin-top: 14px; }
  #modal-desc { font-size:14px; color:#555; white-space: pre-line; }

  .specs { font-size: 18px; line-height: 1.6; margin: 6px 0 10px; }
  .specs .spec-row { margin: 6px 0; }
  .specs .spec-label { font-weight: 800; }
  .specs .spec-val { font-weight: 400; }

  @media (max-width: 600px){
    body { padding: 12px; }
    .catalog-container { gap: 14px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }

    .modal { padding: 0; align-items: stretch; }
    .modal .dialog { width: 100vw; height: 100vh; border-radius: 0; display: flex; flex-direction: column; }
    .modal .header { position: sticky; top: 0; z-index: 5; background: #fff; padding: 12px 14px; }
    .modal .header h2 { font-size: 18px; }

    .modal .body { grid-template-columns: 1fr; gap: 12px; padding: 0; overflow: auto; flex: 1; }
    .m-media { min-height: 60vh; border-radius: 0; }
    .m-rail { aspect-ratio: auto; }
    .m-info { padding: 12px; }

    .m-nav button { width: auto; height: auto; font-size: 20px; }
  }

  @media (orientation: landscape) and (max-width: 900px){
    .m-rail { aspect-ratio: 16/9; }
    .m-media { min-height: 60vh; }
  }

  @media (min-width: 601px) and (max-width: 1000px){
    .modal .dialog { width: 96vw; }
    .modal .body { grid-template-columns: 1.15fr 1fr; }
    .m-media { min-height: clamp(340px, 58vh, 700px); }
  }
</style>

<div class="catalog-toolbar"><input id="search" placeholder="Search inventory…" type="search" /></div>
<div aria-live="polite" class="catalog-container" id="catalog"></div>
<div class="empty" id="empty" style="display:none;">No items match your search.</div>

<div aria-hidden="true" class="modal" id="item-modal">
  <div aria-labelledby="modal-title" aria-modal="true" class="dialog" role="dialog">
    <div class="header">
      <h2 id="modal-title"></h2>
      <button aria-label="Close" class="close" type="button">✕</button>
    </div>
    <div class="body">
      <div class="m-media">
        <div class="m-rail" id="modal-rail"></div>
        <div class="m-nav" id="modal-nav" style="display:none;">
          <button aria-label="Previous" data-dir="-1" type="button">&lsaquo;</button>
          <button aria-label="Next" data-dir="1" type="button">&rsaquo;</button>
        </div>
      </div>
      <div class="m-info">
        <div class="meta" id="modal-meta"></div>
        <div class="specs" id="modal-specs"></div>
        <div class="desc" id="modal-desc"></div>
        <div class="price" id="modal-price"></div>
        <div class="btn-row">
          <a class="btn" href="#" id="modal-view" rel="noopener" style="display:none;" target="_blank">View Item</a>
          <a class="btn" href="https://goldeneaglelive.auctiontechs.com/auction-detail/175375014368881a7f285f0" id="modal-bid" rel="noopener" target="_blank">BID NOW</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSqwYC-Zr3U5qIJ7RdI3IYuxIMj1OHIXmxDiVb3ZFiYgS9SHiyIL1ivSraBg6Jq8GXHB3jYbDfUBVtC/pub?gid=1771094712&single=true&output=csv";
  const AUCTION_BID_URL = "https://goldeneaglelive.auctiontechs.com/auction-detail/175375014368881a7f285f0";
  const COLS = { title:"Title", image:"ImageURL", desc:"Description", link:"LinkURL", price:"Price", caliber:"Caliber", barrel:"Barrel", condition:"Condition" };

  function parseCSV(text){
    const rows=[]; let i=0,field="",row=[],inQuotes=false;
    while(i<text.length){
      const c=text[i],n=text[i+1];
      if(inQuotes){
        if(c==='"'&&n==='"'){field+='"';i+=2;continue}
        if(c==='"'){inQuotes=false;i++;continue}
        field+=c;i++;continue
      }
      if(c==='"'){inQuotes=true;i++;continue}
      if(c===','){row.push(field);field="";i++;continue}
      if(c==='\n'){row.push(field);rows.push(row);field="";row=[];i++;continue}
      if(c==='\r'){i++;continue}
      field+=c;i++
    }
    if(field.length||row.length){row.push(field);rows.push(row)}
    return rows
  }

  const esc  = s => String(s??"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const eattr = s => String(s??"").replace(/"/g,"&quot;");

  function toImageUrl(token){
    if (!token) return "";
    const t = String(token).trim();
    if (/^https?:\/\//i.test(t)){
      if (/(?:\/folders\/)/i.test(t)) return t;
      let id = null;
      const m = t.match(/(?:\/d\/|[?&]id=)([A-Za-z0-9_-]{20,})/);
      if (m) id = m[1];
      if (!id){ try { id = new URL(t).searchParams.get("id"); } catch(e){} }
      if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
      return t;
    }
    return `https://drive.google.com/thumbnail?id=${encodeURIComponent(t)}&sz=w1600`;
  }

  function imagesFromRow(r){
    const out = new Set();
    const pushToken = (tok) => {
      if (!tok) return;
      String(tok).split(/[,;\n]+/).forEach(piece=>{
        const p = piece.trim();
        if (p) out.add(p);
      });
    };
    for (const [key, val] of Object.entries(r)){
      if (!val) continue;
      const k = String(key).trim();
      if (/^(image(url)?\d*|driveid\d*|images?)$/i.test(k)) {
        pushToken(val);
      }
    }
    return Array.from(out);
  }

  const SPEC_FIELDS = [
    {key:"UPC", label:"UPC"},
    {key:"SerialNumber", label:"Serial Number"},
    {key:"Model", label:"Model"},
    {key:"Caliber", label:"Caliber"},
    {key:"BarrelLength", label:"Barrel Length"},
    {key:"Condition", label:"Condition"},
    {key:"ConditionGrade", label:"Condition Grade"},
    {key:"Classification", label:"Classification"},
    {key:"Features", label:"Features"},
  ];
  function parsePairs(desc){
    if(!desc) return {};
    const out={};
    String(desc).split(/\r?\n+/).forEach(line=>{
      const i=line.indexOf(':');
      if(i>0){
        const k=line.slice(0,i).trim().toLowerCase();
        const v=line.slice(i+1).trim();
        if(k) out[k]=v;
      }
    });
    return out;
  }
  function buildSpecs(row, parsed){
    const rows=[];
    for(const f of SPEC_FIELDS){
      let val = row[f.key];
      if(!val && parsed) val = parsed[f.label.toLowerCase()];
      if(val){
        rows.push(`<div class="spec-row"><span class="spec-label">${esc(f.label)}:</span> <span class="spec-val">${esc(val)}</span></div>`);
      }
    }
    return rows.join("");
  }

  const $catalog=document.getElementById("catalog"),
        $empty=document.getElementById("empty"),
        $search=document.getElementById("search"),
        $modal=document.getElementById("item-modal"),
        $modalTitle=document.getElementById("modal-title"),
        $modalMeta=document.getElementById("modal-meta"),
        $modalSpecs=document.getElementById("modal-specs"),
        $modalDesc=document.getElementById("modal-desc"),
        $modalPrice=document.getElementById("modal-price"),
        $modalView=document.getElementById("modal-view"),
        $modalBid=document.getElementById("modal-bid"),
        $modalRail=document.getElementById("modal-rail"),
        $modalNav=document.getElementById("modal-nav");

  let ITEMS=[];
  let INDEX = new WeakMap();

  function rebuildIndex(){
    INDEX = new WeakMap();
    ITEMS.forEach((obj, idx) => INDEX.set(obj, idx));
  }

  const getAny = (obj, keys) => {
    for (const k of keys) { const v = obj[k]; if (v) return v; }
    return "";
  };

  function render(list){
    $catalog.innerHTML="";
    if(!list.length){$empty.style.display="block";return}
    $empty.style.display="none";

    const frag=document.createDocumentFragment();
    for (const it of list){
      const card=document.createElement("article");
      card.className="catalog-item";
      card.setAttribute("role","button");
      card.setAttribute("tabindex","0");

      const idx = INDEX.has(it) ? INDEX.get(it) : -1;
      card.dataset.idx = String(idx);

      const imgs = imagesFromRow(it);
      let thumbHtml = "";
      if (imgs.length){
        const slides = imgs.map(u =>
          `<img referrerpolicy="no-referrer" src="${eattr(toImageUrl(u))}" alt="${esc(it[COLS.title]||"Item image")}" loading="lazy">`
        ).join("");
        const nav = imgs.length>1 ? `<div class="nav"><button class="prev" aria-label="Previous">‹</button><button class="next" aria-label="Next">›</button></div>` : "";
        thumbHtml = `<div class="thumb"><div class="rail">${slides}</div>${nav}</div>`;
      }else{
        thumbHtml = `<div class="thumb"></div>`;
      }

      const metaCaliber = getAny(it, [COLS.caliber, "Caliber"]);
      const metaBarrel  = getAny(it, [COLS.barrel, "Barrel", "BarrelLength", "Barrel Length"]);
      const metaCond    = getAny(it, [COLS.condition, "Condition"]);

      const buttons = `<div class="btn-row">${
        it["LinkURL"]?`<a class="btn" href="${eattr(it["LinkURL"])}" target="_blank" rel="noopener">View Item</a>`:""
      }<a class="btn" href="${AUCTION_BID_URL}" target="_blank" rel="noopener">BID NOW</a></div>`;

      card.innerHTML = `
        ${thumbHtml}
        <div class="pad">
          <h3>${esc(it[COLS.title]||"")}</h3>
          <div class="meta">
            ${metaCaliber?`Caliber: ${esc(metaCaliber)} &nbsp;`:""}
            ${metaBarrel?`Barrel: ${esc(metaBarrel)} &nbsp;`:""}
            ${metaCond?`Condition: ${esc(metaCond)}`:""}
          </div>
          ${it[COLS.desc]?`<div class="desc-snippet">${esc(it[COLS.desc])}</div>`:""}
          ${it[COLS.price]?`<div class="price">$${esc(String(it[COLS.price]).replace(/^\$/, ""))}</div>`:""}
          ${buttons}
        </div>`;
      frag.appendChild(card);
    }
    $catalog.appendChild(frag);
  }

  $catalog.addEventListener("click", (e)=>{
    if (e.target.closest(".thumb .nav button")) return;
    if (e.target.closest("a")) return;
    const card = e.target.closest(".catalog-item");
    if (!card) return;
    const idx = parseInt(card.dataset.idx,10);
    if (Number.isNaN(idx) || idx < 0) return;
    openModal(idx);
  });

  $catalog.addEventListener("click", (e)=>{
    const btn = e.target.closest(".thumb .nav button");
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const thumb = btn.closest(".thumb");
    const rail = thumb ? thumb.querySelector(".rail") : null;
    if (!rail) return;
    const dir = btn.classList.contains("next") ? 1 : -1;
    rail.scrollBy({ left: dir * rail.clientWidth, behavior: "smooth" });
  });

  let scale=1, minScale=1, maxScale=4, tx=0, ty=0;
  let currentImg=null, currentWrap=null;

  function setTransform(){
    if (!currentImg) return;
    currentImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  }
  function resetZoom(){ scale=1; tx=0; ty=0; setTransform(); }
  function clampPan(){
    if (!currentWrap) return;
    const w = currentWrap.clientWidth, h = currentWrap.clientHeight;
    const maxX = (w * (scale - 1)) / 2;
    const maxY = (h * (scale - 1)) / 2;
    tx = Math.max(-maxX, Math.min(maxX, tx));
    ty = Math.max(-maxY, Math.min(maxY, ty));
  }
  function attachSlideRefs(index){
    const slide = $modalRail.querySelectorAll(".slide")[index];
    if (!slide) return;
    currentWrap = slide.querySelector(".zoom-wrap");
    currentImg  = slide.querySelector(".zoom-img");
    resetZoom();
  }
  function buildModalSlides(imgs, title){
    $modalRail.innerHTML = imgs.map(u=>(
      `<div class="slide">
         <div class="zoom-wrap">
           <img referrerpolicy="no-referrer" class="zoom-img" src="${eattr(toImageUrl(u))}" alt="${esc(title||'Item image')}">
         </div>
       </div>`
    )).join("");
    $modalNav.style.display = imgs.length > 1 ? "" : "none";
  }

  function openModal(idx){
    const r = ITEMS[idx];
    if (!r) return;

    $modalTitle.textContent = r[COLS.title] || "Item details";

    const metaCaliber = getAny(r, [COLS.caliber, "Caliber"]);
    const metaBarrel  = getAny(r, [COLS.barrel, "Barrel", "BarrelLength", "Barrel Length"]);
    const metaCond    = getAny(r, [COLS.condition, "Condition"]);
    const parts=[];
    if (metaCaliber) parts.push(`Caliber: ${esc(metaCaliber)}`);
    if (metaBarrel)  parts.push(`Barrel: ${esc(metaBarrel)}`);
    if (metaCond)    parts.push(`Condition: ${esc(metaCond)}`);
    $modalMeta.innerHTML = parts.join(" &nbsp; ");

    const parsedPairs = parsePairs(r[COLS.desc]);
    $modalSpecs.innerHTML = buildSpecs(r, parsedPairs);

    $modalDesc.textContent = r[COLS.desc] || "";
    $modalPrice.textContent = r[COLS.price] ? ("$" + String(r[COLS.price]).replace(/^\$/, "")) : "";

    if (r["LinkURL"]){ $modalView.style.display=""; $modalView.href = r["LinkURL"]; }
    else { $modalView.style.display="none"; $modalView.removeAttribute("href"); }
    $modalBid.href = AUCTION_BID_URL;

    const imgs = imagesFromRow(r);
    buildModalSlides(imgs, r[COLS.title]);

    $modal.classList.add("open");
    $modal.setAttribute("aria-hidden","false");
    $modalRail.scrollLeft = 0;
    attachSlideRefs(0);
  }

  function closeModal(){
    $modal.classList.remove("open");
    $modal.setAttribute("aria-hidden","true");
  }

  document.querySelector("#item-modal .close").addEventListener("click", closeModal);
  $modal.addEventListener("click", (e)=>{ if (e.target === $modal) closeModal(); });

  $modalNav.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-dir]");
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    $modalRail.scrollBy({ left: parseInt(btn.getAttribute("data-dir"),10) * $modalRail.clientWidth, behavior: "smooth" });
  });

  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  let scrollTimer=null;
  $modalRail.addEventListener("scroll", ()=>{
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(()=>{
      const idx = Math.round($modalRail.scrollLeft / $modalRail.clientWidth);
      attachSlideRefs(idx);
    }, 80);
  });

  $modalRail.addEventListener("dblclick", ()=>{
    if (!currentWrap) return;
    scale = (scale === 1) ? 2 : 1; tx=0; ty=0; setTransform();
  });

  $modalRail.addEventListener("wheel", (e)=>{
    if (!e.ctrlKey) return;
    e.preventDefault();
    const delta = Math.sign(e.deltaY);
    scale = Math.max(minScale, Math.min(maxScale, +(scale + (delta > 0 ? -0.25 : 0.25)).toFixed(2)));
    if (scale===1){ tx=0; ty=0; }
    clampPan(); setTransform();
  }, { passive:false });

  let dragging=false, startX=0, startY=0, startTx=0, startTy=0;
  function panStart(clientX, clientY){
    if (scale<=1 || !currentWrap) return;
    dragging=true; startX=clientX; startY=clientY; startTx=tx; startTy=ty;
  }
  function panMove(clientX, clientY){
    if (!dragging) return;
    tx = startTx + (clientX - startX);
    ty = startTy + (clientY - startY);
    clampPan(); setTransform();
  }
  function panEnd(){ dragging=false; }

  $modalRail.addEventListener("mousedown", (e)=>{
    if (!e.target.closest(".zoom-wrap")) return;
    e.preventDefault(); panStart(e.clientX, e.clientY);
  });
  window.addEventListener("mousemove", (e)=>{ if (dragging) panMove(e.clientX, e.clientY); });
  window.addEventListener("mouseup", panEnd);

  let pinchStartDist=null, pinchStartScale=1;
  const distance = (t1,t2)=>Math.hypot(t1.clientX-t2.clientX, t1.clientY-t2.clientY);

  $modalRail.addEventListener("touchstart", (e)=>{
    if (e.touches.length===1){
      const t=e.touches[0]; panStart(t.clientX, t.clientY);
    } else if (e.touches.length===2){
      dragging=false;
      pinchStartDist = distance(e.touches[0], e.touches[1]);
      pinchStartScale = scale;
    }
  }, {passive:false});

  $modalRail.addEventListener("touchmove", (e)=>{
    if (e.touches.length===1 && dragging){
      const t=e.touches[0]; e.preventDefault(); panMove(t.clientX, t.clientY);
    } else if (e.touches.length===2 && pinchStartDist){
      e.preventDefault();
      const d = distance(e.touches[0], e.touches[1]);
      scale = Math.max(1, Math.min(4, (pinchStartScale * d / pinchStartDist)));
      clampPan(); setTransform();
    }
  }, {passive:false});

  $modalRail.addEventListener("touchend", (e)=>{
    if (dragging) panEnd();
    if (!e.touches || e.touches.length < 2) pinchStartDist = null;
  }, {passive:true});

  $modalRail.addEventListener("touchcancel", ()=>{ dragging=false; pinchStartDist=null; }, {passive:true});

  $search.addEventListener("input",()=>{
    const q=$search.value.trim().toLowerCase();
    if(!q) return render(ITEMS);
    const filtered=ITEMS.filter(r=>[r[COLS.title],r[COLS.desc],r[COLS.caliber],r[COLS.condition],r[COLS.barrel],r["Barrel"],r["Barrel Length"]]
      .filter(Boolean).join(" ").toLowerCase().includes(q));
    render(filtered)
  });

  (async function(){
    try{
      const res=await fetch(SHEET_CSV_URL,{cache:"no-store"});
      const csv=await res.text();
      const rows=parseCSV(csv);
      const headers=rows[0];
      const data=rows.slice(1).map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=r[i]||"");return o});
      ITEMS=data.filter(r=>(r[COLS.title]||"").trim().length);
      rebuildIndex();
      render(ITEMS);
    }catch(e){
      console.error(e);
      $catalog.innerHTML=""; $empty.style.display="block";
    }
  })();
</script>
